<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Somauma | Portal de Procedimentos</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100;200;300;400;600;700&display=swap"
      rel="stylesheet" />
    <style>
      /*ESTRUTURAIS*/
      :root {
        --bgcolor: #1e2129;
        --bgcolor2: #1d242b;
        --bgcolor3: #2e363e;
        --bordercolor: #595b61;
        --bordercolor2: #454850;
        --txtcolorbranco: #ffffff;
        --txtcolorcinza: #2e363e;
        --txtcolor1: #68727c;
        --btncolorescuro: #1c2026;
        --btncolorazul: #2b6bf3;
        --btncolorSave: #006bff;
        --btncolorCancel: #ff0057;
        --colorFIN1: #ea4747ff;
        --colorFIN2: #ea47471a;
        --colorFIN3: #ea47473d;
        --colorRHU1: #ff7d43ff;
        --colorRHU2: #ff7d431a;
        --colorRHU3: #ff7d433d;
        --colorJUR1: #c19c00ff;
        --colorJUR2: #c19c001a;
        --colorJUR3: #c19c003d;
        --colorINC1: #9cb543ff;
        --colorINC2: #9cb5431a;
        --colorINC3: #9cb5433d;
        --colorCOM1: #14c988ff;
        --colorCOM2: #14c9881a;
        --colorCOM3: #14c9883d;
        --colorMKT1: #00b8bcff;
        --colorMKT2: #00b8bc1a;
        --colorMKT3: #00b8bc3d;
        --colorENG1: #1679b5ff;
        --colorENG2: #1679b51a;
        --colorENG3: #1679b53d;
        --colorSAC1: #9038f4ff;
        --colorSAC2: #9038f41a;
        --colorSAC3: #9038f43d;
      }
      * {
        box-sizing: border-box;
      }

      /*TAGS NATIVAS*/
      html {
        font-size: 13px;
      }
      @media only screen and (min-width: 600px) {
        html {
          font-size: 14px;
        }
      }
      body {
        background-color: var(--bgcolor);
        margin: 0px 0px 18px 0px;
        color: var(--txtcolorbranco);
      }
      img {
        border: 0px;
      }
      summary {
        list-style: none;
        list-style-type: none;
        cursor: pointer;
      }
      summary::-webkit-details-marker {
        display: none;
      }
      summary::marker {
        content: "";
      }
      ul,
      ol,
      li {
        list-style: none;
        list-style-type: none;
      }
      summary:active {
        transform: translateY(1px);
      }
      input,
      select,
      textarea {
        color: white;
        font-family: "Roboto Slab", serif;
        font-size: 1.1rem;
        padding: 4px;
        margin-bottom: 0.6rem;
        background-color: var(--bgcolor2);
        border: 1px solid var(--bordercolor);
        border-radius: 0.4rem;
        box-shadow: none;
        outline: none;
        -webkit-box-shadow: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-clip: padding-box;
      }

      /*CLASSES*/
      .wrap {
        max-width: 600px;
        width: 100%;
        margin: auto;
        padding: 0 12px;
      }
      .tituloPagina {
        display: flex;
        justify-content: center;
        padding: 18px 0px 18px 0px;
        font-size: 1.6rem;
        font-family: "Roboto Slab", serif;
        font-weight: 700;
        color: var(--txtcolorbranco);
      }
      .inputFormBar {
        display: flex;
        flex-direction: column;
        padding: 18px 0px 0px 0px;
      }
      .inputFormBox {
        display: flex;
        flex-direction: column;
        padding: 18px;
        border: 1px solid var(--bordercolor2);
        border-radius: 0.6rem;
        background-color: var(--bgcolor3);
        box-shadow: 0px 0px 10px black;
      }
      .inputDateBar {
        display: flex;
        gap: 6px;
        justify-content: space-between;
      }
      .inputLabel {
        font-family: "Roboto Slab", serif;
        font-size: 1.1rem;
        margin-bottom: 0.4rem;
        color: var(--txtcolor1);
      }
      .inputActionsBar {
        display: flex;
        justify-content: space-between;
        margin-top: 0.4rem;
        gap: 6px;
      }
      .botaoOkActionsBar {
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
        font-family: "Roboto Slab", serif;
        color: var(--txtcolorbranco);
        background-color: #006bff;
        border-radius: 0.4rem;
        cursor: pointer;
        text-decoration: none;
      }
      .botaoCancelActionsBar {
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
        font-family: "Roboto Slab", serif;
        color: var(--txtcolorbranco);
        background-color: #ff0057;
        border-radius: 0.4rem;
        cursor: pointer;
        text-decoration: none;
      }
      .botaoOkActionsBar:active,
      .botaoCancelActionsBar:active {
        transform: translateY(1px);
      }
      .tituloDeptoBar {
        display: flex;
        justify-content: space-between;
        padding: 18px;
        background-color: var(--bgcolor3);
        border-top: 1px solid var(--bordercolor);
        border-bottom: 1px solid var(--bordercolor);
        margin: 18px 0px 0px 0px;
      }
      .tituloDepto {
        font-size: 1.4rem;
        font-family: "Roboto Slab", serif;
        font-weight: 700;
        color: var(--txtcolorbranco);
      }
      .tituloDeptoUpDown {
        align-content: center;
        font-size: 0.9rem;
        font-family: "Roboto Slab", serif;
        font-weight: 700;
        color: var(--txtcolorbranco);
      }
      .logoHeader {
        display: flex;
        justify-content: center;
        padding: 36px;
      }
      .boxProcedimento {
        display: flex;
        flex-direction: column;
        padding: 18px;
        margin-bottom: 18px;
        border: 1px solid var(--bordercolor2);
        background-color: var(--bgcolor2);
        border-radius: 0.6rem;
        box-shadow: 0px 0px 10px black;
      }
      .boxProcedimentoTitleBar {
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        padding: 0px 0px 18px 0px;
      }
      .boxProcedimentoTitleBox {
        display: flex;
        gap: 9px;
      }
      .boxProcedimentoTitle {
        display: flex;
        justify-content: left;
        font-family: "Roboto Slab", serif;
        font-weight: 700;
        font-size: 1.4rem;
        padding: 6px 0px 6px 0px;
      }
      .boxProcedimentoCode {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 6rem;
        border: 1px solid var(--bordercolor);
        border-radius: 0.5rem;
        font-family: "Roboto Slab", serif;
        font-weight: 400;
        font-size: 1.1rem;
        padding: 6px;
      }
      .boxProcedimentoDate {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 7rem;
        border: 1px solid var(--bordercolor);
        border-radius: 0.5rem;
        font-family: "Roboto Slab", serif;
        font-weight: 400;
        font-size: 1.1rem;
        padding: 6px;
      }
      .boxProcedimentoDelete {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 2.5rem;
        border-radius: 0.5rem;
        font-family: "Arial", serif;
        font-weight: 700;
        font-size: 1.1rem;
        padding: 6px;
        background-color: #ffffff3d;
        cursor: pointer;
      }
      .boxProcedimentoDelete:active {
        transform: translateY(1px);
      }
      .boxProcedimentoResumo {
        font-family: "Roboto Slab", serif;
        font-weight: 200;
        font-size: 1.1rem;
        padding: 0px 0px 14px 0px;
      }
      .linhaH {
        background-color: var(--bordercolor);
        height: 1px;
      }
      .container {
        margin-top: 18px;
      }
      .botao {
        display: flex;
        justify-content: center;
        width: 12rem;
        padding: 12px;
        font-size: 1.1rem;
        font-family: "Roboto Slab", serif;
        color: var(--txtcolorbranco);
        background-color: var(--btncolorazul);
        border-radius: 0.4rem;
        cursor: pointer;
        text-decoration: none;
      }
      .botao:active {
        transform: translateY(1px);
      }
      .brFake {
        padding: 9px;
      }
      .footerBar {
        display: flex;
        padding: 18px 0px 18px 0px;
        justify-content: center;
      }
      .footerText {
        font-family: "Roboto Slab", serif;
        font-size: 1.1rem;
        font-weight: 200;
        color: var(--bordercolor);
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="logoHeader"><img src="somauma_logo_branca_baixa_cropped.png" width="120px" /></div>
      <div class="linhaH"></div>
      <div class="tituloPagina">PORTAL DE PROCEDIMENTOS</div>
      <div class="linhaH"></div>

      <!--ADMINISTRATIVO / FINANCEIRO-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorFIN3)">
            <span class="tituloDepto">ADMINISTRATIVO / FINANCEIRO</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-FIN"></div>
      </details>

      <!--RECURSOS HUMANOS-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorRHU3)">
            <span class="tituloDepto">RECURSOS HUMANOS</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-RHU"></div>
      </details>

      <!--JURÍDICO-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorJUR3)">
            <span class="tituloDepto">JURÍDICO</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-JUR"></div>
      </details>

      <!--PROJETOS / INCORPORAÇÃO-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorINC3)">
            <span class="tituloDepto">PROJETOS / INCORPORAÇÃO</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-INC"></div>
      </details>

      <!--COMERCIAL-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorCOM3)">
            <span class="tituloDepto">COMERCIAL</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-COM"></div>
      </details>

      <!--MARKETING E COMUNICAÇÃO-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorMKT3)">
            <span class="tituloDepto">MARKETING / COMUNICAÇÃO</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-MKT"></div>
      </details>

      <!--ENGENHARIA / CONSTRUÇÃO-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorENG3)">
            <span class="tituloDepto">ENGENHARIA / CONSTRUÇÃO</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-ENG"></div>
      </details>

      <!--SAC / ASSISTÊNCIA TÉCNICA-->
      <details>
        <summary>
          <span class="tituloDeptoBar" style="background-color: var(--colorSAC3)">
            <span class="tituloDepto">SAC / ASSISTÊNCIA TÉCNICA</span>
            <span class="tituloDeptoUpDown">▼▲</span>
          </span>
        </summary>
        <div class="container" id="lista-SAC"></div>
      </details>

      <!--FORMULÁRIO DE INPUT-->
      <div class="inputFormBar">
        <details>
          <summary>
            <a
              class="botao"
              style="border: 1px solid var(--bordercolor2); background-color: var(--bgcolor); width: 100%"
              >Novo Procedimento</a
            >
          </summary>
          <div class="brFake"></div>

          <div class="inputFormBox">
            <label class="inputLabel">Departamento:</label>
            <select id="f-departamento">
              <option value="FIN">Administrativo / Financeiro</option>
              <option value="RHU">Recursos Humanos</option>
              <option value="JUR">Jurídico</option>
              <option value="INC">Projetos / Incorporação</option>
              <option value="COM">Comercial</option>
              <option value="MKT">Marketing / Comunicação</option>
              <option value="ENG">Engenharia / Construção</option>
              <option value="SAC">SAC / Assistência Técnica</option>
            </select>

            <label class="inputLabel">Código:</label>
            <input id="f-codigo" placeholder="Ex: JUR#003" />

            <label class="inputLabel">Data de Publicação:</label>
            <div class="inputDateBar">
              <select id="f-dia" style="width: 100%">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
                <option value="7">7</option><option value="8">8</option><option value="9">9</option>
                <option value="10">10</option><option value="11">11</option><option value="12">12</option>
                <option value="13">13</option><option value="14">14</option><option value="15">15</option>
                <option value="16">16</option><option value="17">17</option><option value="18">18</option>
                <option value="19">19</option><option value="20">20</option><option value="21">21</option>
                <option value="22">22</option><option value="23">23</option><option value="24">24</option>
                <option value="25">25</option><option value="26">26</option><option value="27">27</option>
                <option value="28">28</option><option value="29">29</option><option value="30">30</option>
                <option value="31">31</option>
              </select>

              <select id="f-mes" style="width: 100%">
                <option value="JAN">Janeiro</option>
                <option value="FEV">Fevereiro</option>
                <option value="MAR">Março</option>
                <option value="ABR">Abril</option>
                <option value="MAI">Maio</option>
                <option value="JUN">Junho</option>
                <option value="JUL">Julho</option>
                <option value="AGO">Agosto</option>
                <option value="SET">Setembro</option>
                <option value="OUT">Outubro</option>
                <option value="NOV">Novembro</option>
                <option value="DEZ">Dezembro</option>
              </select>

              <select id="f-ano" style="width: 100%">
                <option value="2026">2026</option>
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
                <option value="2023">2023</option>
                <option value="2022">2022</option>
                <option value="2021">2021</option>
                <option value="2020">2020</option>
              </select>
            </div>

            <label class="inputLabel">Título do Procedimento:</label>
            <input id="f-titulo" />

            <label class="inputLabel">Resumo do Procedimento:</label>
            <textarea id="f-resumo" rows="4"></textarea>

            <label class="inputLabel">Link do Documento:</label>
            <input id="f-link" placeholder="https://drive.google.com/..." />

            <div class="inputActionsBar">
              <a class="botaoOkActionsBar" id="btn-publicar">Publicar</a>
              <a class="botaoCancelActionsBar" id="btn-cancelar">Cancelar</a>
            </div>
          </div>
        </details>
      </div>

      <div class="brFake"></div>
      <div class="linhaH"></div>
      <div class="footerBar">
        <span class="footerText">® Somauma , 2025.</span>
      </div>
      <!-- FIM DA PÁGINA -->
    </div>

    <script>
      // IMPORTANTE: frontend está no GitHub Pages; backend/API está no Render
      const API_BASE = "https://procedimentos-37ui.onrender.com";

      const MES_MAP = {
        JAN: "01", FEV: "02", MAR: "03", ABR: "04", MAI: "05", JUN: "06",
        JUL: "07", AGO: "08", SET: "09", OUT: "10", NOV: "11", DEZ: "12"
      };

      function formatDateBR(iso) {
        const [y, m, d] = iso.split("-");
        return `${d}/${m}/${y}`;
      }

      function escapeHtml(str) {
        return String(str)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function cardProcedimento(p) {
        const depto = escapeHtml(p.departamento);
        const codigo = escapeHtml(p.codigo);
        const titulo = escapeHtml(p.titulo);
        const resumo = escapeHtml(p.resumo);
        const link = escapeHtml(p.link);
        const data = escapeHtml(formatDateBR(p.data_publicacao));

        return `
          <div class="boxProcedimento" style="background-color: var(--color${depto}2)">
            <div class="boxProcedimentoTitleBar">
              <div class="boxProcedimentoTitleBox">
                <div class="boxProcedimentoCode">${codigo}</div>
                <div class="boxProcedimentoDate">${data}</div>
              </div>
              <div class="boxProcedimentoDelete" data-del="${p.id}" title="Excluir">⨉</div>
            </div>

            <div class="boxProcedimentoTitleBar">
              <div class="boxProcedimentoTitle">${titulo}</div>
            </div>

            <div class="boxProcedimentoResumo">${resumo}</div>

            <a
              href="${link}"
              class="botao"
              target="_blank"
              rel="noopener noreferrer"
              style="background-color: var(--color${depto}1)"
            >Ver Procedimento</a>
          </div>
        `;
      }

      async function carregarTudo() {
        try {
          const res = await fetch(`${API_BASE}/api/procedimentos`);
          const text = await res.text();

          if (!res.ok) {
            alert(`Erro ao carregar lista (HTTP ${res.status}).\n\n${text.slice(0, 400)}`);
            return;
          }

          const lista = JSON.parse(text);

          ["FIN","RHU","JUR","INC","COM","MKT","ENG","SAC"].forEach(d => {
            const el = document.getElementById(`lista-${d}`);
            if (el) el.innerHTML = "";
          });

          for (const p of lista) {
            const alvo = document.getElementById(`lista-${p.departamento}`);
            if (!alvo) continue;

            const wrap = document.createElement("div");
            wrap.className = "container";
            wrap.innerHTML = cardProcedimento(p);
            alvo.appendChild(wrap);
          }
        } catch (err) {
          alert("Falha de rede/CORS ao carregar lista.\n\n" + (err?.message || err));
          console.error(err);
        }
      }

      function limparForm() {
        document.getElementById("f-codigo").value = "";
        document.getElementById("f-titulo").value = "";
        document.getElementById("f-resumo").value = "";
        document.getElementById("f-link").value = "";
      }

      async function criarProcedimento() {
        try {
          const departamento = document.getElementById("f-departamento").value;
          const codigo = document.getElementById("f-codigo").value.trim();
          const dia = document.getElementById("f-dia").value;
          const mes = document.getElementById("f-mes").value;
          const ano = document.getElementById("f-ano").value;
          const titulo = document.getElementById("f-titulo").value.trim();
          const resumo = document.getElementById("f-resumo").value.trim();
          const link = document.getElementById("f-link").value.trim();

          const data_publicacao = `${ano}-${MES_MAP[mes]}-${String(dia).padStart(2, "0")}`;

          if (!codigo || !titulo || !resumo || !link) {
            alert("Preencha Código, Título, Resumo e Link.");
            return;
          }

          const payload = { departamento, codigo, data_publicacao, titulo, resumo, link };

          const res = await fetch(`${API_BASE}/api/procedimentos`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          const text = await res.text(); // pega body mesmo se vier HTML de erro

          if (!res.ok) {
            alert(`Erro ao publicar (HTTP ${res.status}).\n\n${text.slice(0, 400)}`);
            return;
          }

          limparForm();
          await carregarTudo();
          alert("Publicado!");
        } catch (err) {
          alert("Falha de rede/CORS ao chamar a API.\n\n" + (err?.message || err));
          console.error(err);
        }
      }

      async function deletarProcedimento(id) {
        try {
          const ok = confirm("Excluir este procedimento?");
          if (!ok) return;

          const res = await fetch(`${API_BASE}/api/procedimentos/${id}`, { method: "DELETE" });
          const text = await res.text();

          if (!res.ok) {
            alert(`Erro ao excluir (HTTP ${res.status}).\n\n${text.slice(0, 400)}`);
            return;
          }

          await carregarTudo();
        } catch (err) {
          alert("Falha de rede/CORS ao excluir.\n\n" + (err?.message || err));
          console.error(err);
        }
      }

      // Eventos
      document.addEventListener("click", (e) => {
        const del = e.target?.getAttribute?.("data-del");
        if (del) deletarProcedimento(del);
      });

      document.getElementById("btn-publicar")?.addEventListener("click", (e) => {
        e.preventDefault();
        criarProcedimento();
      });

      document.getElementById("btn-cancelar")?.addEventListener("click", (e) => {
        e.preventDefault();
        limparForm();
      });

      carregarTudo();
    </script>
  </body>
</html>
